<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.5.1.final using JasperReports Library version 6.5.1  -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="sub_report_boundaries" pageWidth="595" pageHeight="842" columnWidth="595" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="20" uuid="8044c259-bf6b-4072-8923-78bca3eb0308">
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="New Data Adapter "/>
	<property name="com.jaspersoft.studio.unit." value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageHeight" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.pageWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.topMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.bottomMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.leftMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.rightMargin" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnWidth" value="pixel"/>
	<property name="com.jaspersoft.studio.unit.columnSpacing" value="pixel"/>
	<property name="com.jaspersoft.studio.property.dataset.dialog.DatasetDialog.sash.w1" value="779"/>
	<property name="com.jaspersoft.studio.property.dataset.dialog.DatasetDialog.sash.w2" value="212"/>
	<property name="com.jaspersoft.studio.data.sql.SQLQueryDesigner.sash.w1" value="220"/>
	<property name="com.jaspersoft.studio.data.sql.SQLQueryDesigner.sash.w2" value="774"/>
	<parameter name="id" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[66040]]></defaultValueExpression>
	</parameter>
	<parameter name="criterio_punto_inicial" class="java.lang.Integer"/>
	<parameter name="datasetName" class="java.lang.String"/>
	<queryString language="SQL">
		<![CDATA[WITH
parametros AS (
  SELECT
    $P{id} 	AS terreno_t_id,
    $P{criterio_punto_inicial} 		AS criterio_punto_inicial, --tipo de criterio para seleccionar el punto inicial del terreno, valores posibles: 1,2 parametrizar
     4		AS criterio_observador, --1: Centroide, 2: Centro del extent, 3: punto en la superficie, 4: Punto mas cercano al centroide dentro del poligono
	false	AS incluir_tipo_derecho, --Mostrar el tipo de derecho de cada interesado (booleano)
	15		AS tolerancia_sentidos --tolerancia en grados para la definicion del sentido de una linea
),
t AS (
	SELECT t_id, ST_ForceRHR(geometria) AS geometria FROM $P!{datasetName}.lc_terreno WHERE t_id = (SELECT terreno_t_id FROM parametros)
),
linderos AS (
	SELECT lc_lindero.t_id, lc_lindero.geometria AS geom  FROM $P!{datasetName}.lc_lindero JOIN $P!{datasetName}.col_masccl ON col_masccl.ue_mas_lc_terreno = (SELECT terreno_t_id FROM parametros) AND lc_lindero.t_id = col_masccl.ccl_mas
),
terrenos_asociados_linderos AS (
	SELECT DISTINCT col_masccl.ue_mas_lc_terreno AS t_id_terreno, col_masccl.ccl_mas AS t_id_lindero FROM $P!{datasetName}.col_masccl WHERE col_masccl.ccl_mas IN (SELECT t_id FROM linderos) AND col_masccl.ue_mas_lc_terreno != (SELECT terreno_t_id FROM parametros)
),
puntos_lindero AS (
	SELECT lc_puntolindero.t_id, lc_puntolindero.geometria AS geom FROM $P!{datasetName}.lc_puntolindero JOIN $P!{datasetName}.col_puntoccl ON col_puntoccl.ccl IN (SELECT t_id FROM linderos) AND lc_puntolindero.t_id = col_puntoccl.punto_lc_puntolindero
),
puntos_terreno AS (
	SELECT (ST_DumpPoints(geometria)).* AS dp,
			ST_NPoints(geometria) total
	FROM t
),
--bordes de la extension del poligono
punto_nw AS (
	SELECT ST_SetSRID(ST_MakePoint(st_xmin(t.geometria), st_ymax(t.geometria)), ST_SRID(t.geometria)) AS p FROM t
),
punto_ne AS (
	SELECT ST_SetSRID(ST_MakePoint(st_xmax(t.geometria), st_ymax(t.geometria)), ST_SRID(t.geometria)) AS p FROM t
),
punto_se AS (
	SELECT ST_SetSRID(ST_MakePoint(st_xmax(t.geometria), st_ymin(t.geometria)), ST_SRID(t.geometria)) AS p FROM t
),
punto_sw AS (
	SELECT ST_SetSRID(ST_MakePoint(st_xmin(t.geometria), st_ymin(t.geometria)), ST_SRID(t.geometria)) AS p FROM t
),
--Punto medio (ubicaciÃ³n del observador para la definicion de las cardinalidades)
punto_medio AS (
  SELECT
    CASE WHEN criterio_observador = 1 THEN --centroide del poligono
      ( SELECT ST_SetSRID(ST_MakePoint(st_x(ST_centroid(t.geometria)), st_y(ST_centroid(t.geometria))), ST_SRID(t.geometria)) AS p FROM t )
    WHEN criterio_observador = 2 THEN --Centro del extent
      ( SELECT ST_SetSRID(ST_MakePoint(st_x(ST_centroid(st_envelope(t.geometria))), st_y(ST_centroid(st_envelope(t.geometria)))), ST_SRID(t.geometria)) AS p FROM t )
    WHEN criterio_observador = 3 THEN --Punto en la superficie
      ( SELECT ST_SetSRID(ST_PointOnSurface(geometria), ST_SRID(t.geometria)) AS p FROM t )
    WHEN criterio_observador = 4 THEN --Punto mas cercano al centroide pero que se intersecte el poligono si esta fuera
      ( SELECT ST_SetSRID(ST_MakePoint(st_x( ST_ClosestPoint( geometria, ST_centroid(t.geometria))), st_y( ST_ClosestPoint( geometria,ST_centroid(t.geometria)))), ST_SRID(t.geometria)) AS p FROM t )
    ELSE --defecto: Centro del extent
      ( SELECT ST_SetSRID(ST_MakePoint(st_x(ST_centroid(st_envelope(t.geometria))), st_y(ST_centroid(st_envelope(t.geometria)))), ST_SRID(t.geometria)) AS p FROM t )
    END AS p
    FROM parametros
),
cuadrante_norte AS (
	SELECT ST_SetSRID(ST_MakePolygon(ST_MakeLine(ARRAY [punto_nw.p, punto_ne.p, punto_medio.p, punto_nw.p])), ST_SRID(t.geometria)) geom FROM t, punto_nw, punto_ne, punto_medio
),
cuadrante_este AS (
	SELECT ST_SetSRID(ST_MakePolygon(ST_MakeLine(ARRAY [punto_medio.p, punto_ne.p, punto_se.p, punto_medio.p])), ST_SRID(t.geometria)) geom FROM t,punto_ne,punto_se,punto_medio
),
cuadrante_sur AS (
	SELECT ST_SetSRID(ST_MakePolygon(ST_MakeLine(ARRAY [punto_medio.p, punto_se.p, punto_sw.p, punto_medio.p])), ST_SRID(t.geometria)) geom FROM t,punto_medio,punto_se,punto_sw
),
cuadrante_oeste AS (
	SELECT ST_SetSRID(ST_MakePolygon(ST_MakeLine(ARRAY [punto_nw.p, punto_medio.p, punto_sw.p, punto_nw.p])), ST_SRID(t.geometria)) geom FROM t,punto_nw,punto_medio,punto_sw
),
cuadrantes AS (
	SELECT '1_Norte' ubicacion, geom AS cuadrante FROM cuadrante_norte
	UNION
	SELECT '2_Este' ubicacion, geom AS cuadrante FROM cuadrante_este
	UNION
	SELECT '3_Sur' ubicacion, geom AS cuadrante FROM cuadrante_sur
	UNION
	SELECT '4_Oeste' ubicacion, geom AS cuadrante FROM cuadrante_oeste
),
punto_inicial_por_lindero_porcentaje_n AS (
	SELECT 	round((st_length(st_intersection(linderos.geom, cuadrante_norte.geom))/st_length(linderos.geom))::numeric,2) dist,
		st_startpoint(linderos.geom) geom
		,st_distance(linderos.geom, punto_nw.p) distance_to_nw
		FROM linderos
			,cuadrante_norte
			, punto_nw
		WHERE st_intersects(linderos.geom, cuadrante_norte.geom)  ORDER BY dist DESC, distance_to_nw
		LIMIT 1
),
punto_inicial_por_lindero_con_punto_nw AS (
	SELECT 	geom,
			st_distance(geom, nw) AS dist
	FROM puntos_terreno,
		(SELECT ST_SetSRID(ST_MakePoint(st_xmin(st_envelope(geometria)), st_ymax(st_envelope(geometria))), ST_SRID(geometria)) AS nw FROM t) a
	ORDER BY dist LIMIT 1
),
punto_inicial AS (
	SELECT
		CASE WHEN criterio_punto_inicial = 1 THEN (SELECT geom FROM punto_inicial_por_lindero_con_punto_nw)
		WHEN criterio_punto_inicial = 2 THEN (SELECT geom FROM punto_inicial_por_lindero_porcentaje_n)
	END AS geom
	FROM parametros
),
puntos_terreno_ordenados AS (
	SELECT CASE WHEN id-m+1 <= 0 THEN total + id-m ELSE id-m+1 END AS id, geom  FROM
		(
		SELECT row_number() OVER (ORDER BY path) AS id
			,m
			,path
			,geom
			,total
		FROM (
			SELECT (ST_DumpPoints(geometria)).* AS dp
				,ST_NPoints(geometria) total
				,geometria
			FROM t
			) AS a
			,(
				SELECT row_number() OVER (ORDER BY path) AS m
					,st_distance(puntos_terreno.geom, punto_inicial.geom) AS dist
				FROM puntos_terreno,punto_inicial
				ORDER BY dist LIMIT 1
			) b
		) t
		WHERE id <> total
	ORDER BY id
),
puntos_lindero_ordenados AS (
    SELECT * FROM (
        SELECT DISTINCT ON (t_id) t_id, id, st_distance(puntos_lindero.geom, puntos_terreno_ordenados.geom) AS distance, puntos_lindero.geom, st_x(puntos_lindero.geom) x, st_y(puntos_lindero.geom) y
        FROM puntos_lindero, puntos_terreno_ordenados ORDER BY t_id, distance
        LIMIT (SELECT count(DISTINCT t_id) FROM puntos_lindero)
    ) tmp_puntos_lindero_ordenados ORDER BY id
),
linderos_desde_hasta AS (
	SELECT *
		, (SELECT id FROM (
			SELECT id, st_distance(puntos_lindero_ordenados.geom, st_startpoint(linderos.geom)) AS distance FROM puntos_lindero_ordenados ORDER BY distance ASC LIMIT 1
		) AS tmp_desde) desde
		, (SELECT id FROM (
			SELECT id, st_distance(puntos_lindero_ordenados.geom, st_endpoint(linderos.geom)) AS distance FROM puntos_lindero_ordenados ORDER BY distance ASC LIMIT 1
		) AS tmp_hasta) hasta
	FROM linderos
	ORDER BY desde
),
linderos_colindantes AS (
	SELECT row_number() OVER (ORDER BY desde) AS id, t_id AS t_id_linderos, desde, hasta, ubicacion, geom FROM
	(
		SELECT *
			,st_length(st_intersection(geom,cuadrante))/st_length(geom) AS porcentaje
			,max(st_length(st_intersection(geom,cuadrante))/st_length(geom)) OVER (partition BY geom) AS max_porce
		FROM linderos_desde_hasta, cuadrantes WHERE st_intersects(geom,  cuadrante)
	) a
	WHERE porcentaje = max_porce
),
colindantes AS (
	SELECT linderos_colindantes.*, terrenos_asociados_linderos.t_id_terreno  FROM linderos_colindantes JOIN terrenos_asociados_linderos ON linderos_colindantes.t_id_linderos = terrenos_asociados_linderos.t_id_lindero
),
predios_seleccionados AS (
	SELECT baunit AS t_id_predio, colindantes.t_id_terreno AS t_id_colindante FROM colindantes
	LEFT JOIN $P!{datasetName}.col_uebaunit ON colindantes.t_id_terreno = ue_lc_terreno
),
derechos_seleccionados AS (
	 SELECT DISTINCT lc_derecho.t_id AS t_id_derecho, predios_seleccionados.t_id_colindante
	 FROM predios_seleccionados LEFT JOIN $P!{datasetName}.lc_derecho
	 ON lc_derecho.unidad = predios_seleccionados.t_id_predio
 ),
 derecho_interesados AS (
	 SELECT DISTINCT lc_derecho.interesado_lc_interesado, lc_derecho.t_id AS t_id_derecho, derechos_seleccionados.t_id_colindante
	 FROM derechos_seleccionados LEFT JOIN $P!{datasetName}.lc_derecho
	 ON lc_derecho.t_id = derechos_seleccionados.t_id_derecho WHERE lc_derecho.interesado_lc_interesado IS NOT NULL
 ),
 derecho_agrupacion_interesados AS (
	 SELECT DISTINCT lc_derecho.interesado_lc_agrupacioninteresados, col_miembros.interesado_lc_interesado, derechos_seleccionados.t_id_colindante, col_miembros.agrupacion
	 FROM derechos_seleccionados LEFT JOIN $P!{datasetName}.lc_derecho
	 ON lc_derecho.t_id = derechos_seleccionados.t_id_derecho
	 LEFT JOIN $P!{datasetName}.col_miembros
	 ON lc_derecho.interesado_lc_agrupacioninteresados = col_miembros.agrupacion
	 WHERE lc_derecho.interesado_lc_agrupacioninteresados IS NOT NULL
 ),
 info_agrupacion_filter AS (
		SELECT DISTINCT ON (agrupacion) agrupacion
		,lc_interesado.local_id AS local_id
		,(CASE WHEN lc_interesado.t_id IS NOT null THEN 'agrupacion' END) AS agrupacion_interesado
	 	,(coalesce(lc_interesado.primer_nombre,'') || coalesce(' ' || lc_interesado.segundo_nombre, '') || coalesce(' ' || lc_interesado.primer_apellido, '') || coalesce(' ' || lc_interesado.segundo_apellido, '')
				|| coalesce(lc_interesado.razon_social, '') ) AS nombre
		,t_id_colindante
		FROM derecho_agrupacion_interesados LEFT JOIN $P!{datasetName}.lc_interesado ON lc_interesado.t_id = derecho_agrupacion_interesados.interesado_lc_interesado order BY agrupacion
 ),
 info_interesado AS (
		SELECT
	 	lc_interesado.local_id AS local_id
	 	,(CASE WHEN lc_interesado.t_id IS NOT null THEN 'interesado' END) AS agrupacion_interesado
	 	,(coalesce(lc_interesado.primer_nombre,'') || coalesce(' ' || lc_interesado.segundo_nombre, '') || coalesce(' ' || lc_interesado.primer_apellido, '') || coalesce(' ' || lc_interesado.segundo_apellido, '')
				|| coalesce(lc_interesado.razon_social, '') ) AS nombre
		,t_id_colindante
 		FROM derecho_interesados LEFT JOIN $P!{datasetName}.lc_interesado ON lc_interesado.t_id = derecho_interesados.interesado_lc_interesado
 ),
 info_agrupacion AS (
		SELECT local_id
		,agrupacion_interesado
		,nombre
		,t_id_colindante
		FROM info_agrupacion_filter
),
 info_total_interesados AS (SELECT * FROM info_interesado UNION all SELECT * FROM info_agrupacion)
 SELECT
   id
  ,desde
  ,hasta
  ,ubicacion
  ,round(st_x(st_startpoint(colindantes.geom))::numeric,2) xi
  ,round(st_y(st_startpoint(colindantes.geom))::numeric,2) yi
  ,round(st_x(st_endpoint(colindantes.geom))::numeric,2) xf
  ,round(st_y(st_endpoint(colindantes.geom))::numeric,2) yf
  ,COALESCE(info_total_interesados.nombre, 'INDETERMINADO') AS interesado
  ,COALESCE(info_total_interesados.agrupacion_interesado, 'INDETERMINADO') AS tipo_interesado
  ,round(st_length(colindantes.geom)::numeric,2) distancia
  ,(SELECT array_to_string( array_agg(puntos_lindero_ordenados.id || ': N=' || round(st_y(puntos_lindero_ordenados.geom)::numeric,2) || ' metros (m.), E=' || round(st_x(puntos_lindero_ordenados.geom)::numeric,2) || ' metros (m.)'), '; ') FROM puntos_lindero_ordenados WHERE st_intersects(colindantes.geom,puntos_lindero_ordenados.geom) and puntos_lindero_ordenados.id NOT IN (desde, hasta) ) AS nodos
  ,degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2)))
  ,CASE WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 360-(SELECT tolerancia_sentidos FROM parametros) and 360 or degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 0 and (SELECT tolerancia_sentidos FROM parametros) THEN 'norte'
	  WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN (SELECT tolerancia_sentidos FROM parametros) and 90-(SELECT tolerancia_sentidos FROM parametros) THEN 'noreste'
	  WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 90-(SELECT tolerancia_sentidos FROM parametros) and 90+(SELECT tolerancia_sentidos FROM parametros) THEN 'este'
	  WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 90+(SELECT tolerancia_sentidos FROM parametros) and 180-(SELECT tolerancia_sentidos FROM parametros) THEN 'sureste'
	  WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 180-(SELECT tolerancia_sentidos FROM parametros) and 180+(SELECT tolerancia_sentidos FROM parametros) THEN 'sur'
	  WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 180+(SELECT tolerancia_sentidos FROM parametros) and 270-(SELECT tolerancia_sentidos FROM parametros) THEN 'suroeste'
	  WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 270-(SELECT tolerancia_sentidos FROM parametros) and 270+(SELECT tolerancia_sentidos FROM parametros) THEN 'oeste'
	  WHEN degrees(ST_Azimuth(st_startpoint(geom),ST_PointN(geom,2))) BETWEEN 270+(SELECT tolerancia_sentidos FROM parametros) and 360-(SELECT tolerancia_sentidos FROM parametros) THEN 'noroeste'
  END AS sentido
  ,(SELECT count(*) FROM colindantes) AS total_linderos
 FROM colindantes LEFT JOIN info_total_interesados ON colindantes.t_id_terreno = info_total_interesados.t_id_colindante
 WHERE ubicacion = '3_Sur']]>
	</queryString>
	<field name="id" class="java.lang.Long"/>
	<field name="desde" class="java.lang.Long"/>
	<field name="hasta" class="java.lang.Long"/>
	<field name="ubicacion" class="java.lang.String"/>
	<field name="xi" class="java.math.BigDecimal"/>
	<field name="yi" class="java.math.BigDecimal"/>
	<field name="xf" class="java.math.BigDecimal"/>
	<field name="yf" class="java.math.BigDecimal"/>
	<field name="interesado" class="java.lang.String"/>
	<field name="tipo_interesado" class="java.lang.String"/>
	<field name="distancia" class="java.math.BigDecimal"/>
	<field name="nodos" class="java.lang.String"/>
	<field name="degrees" class="java.lang.Double"/>
	<field name="sentido" class="java.lang.String"/>
	<field name="total_linderos" class="java.lang.Long"/>
	<detail>
		<band height="23" splitType="Stretch">
			<property name="com.jaspersoft.studio.layout" value="com.jaspersoft.studio.editor.layout.FreeLayout"/>
			<textField isStretchWithOverflow="true" pattern="" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="20" y="1" width="520" height="19" isPrintWhenDetailOverflows="true" uuid="e9c4fcf3-43da-4f4c-b8f9-7ef03c16a6d9">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<box bottomPadding="10">
					<topPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<leftPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<bottomPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
					<rightPen lineWidth="0.0" lineStyle="Solid" lineColor="#000000"/>
				</box>
				<textElement textAlignment="Justified" verticalAlignment="Middle" markup="html">
					<font size="9"/>
					<paragraph lineSpacing="Single" lineSpacingSize="2.0" firstLineIndent="20" leftIndent="5" rightIndent="5"/>
				</textElement>
				<textFieldExpression><![CDATA["<b>LINDERO " + $F{id}+ ":</b> Partiendo del punto " + $F{desde} + " con coordenadas N=" + $F{yi} + " metros (m.), E=" + $F{xi} + " metros (m.)" + ($F{nodos} != null ? " en lÃ­nea quebrada" :" en lÃ­nea recta") + " y en sentido " + $F{sentido} +  ($F{nodos} != null ? " pasando por los puntos y coordenadas " + $F{nodos} + ", con una distancia acumulada de " :" en distancia de ") + $F{distancia} + " metros (m.) hasta el punto " + $F{hasta} + " con coordenadas N=" + $F{yf} + " metros (m.), E="  + $F{xf} + " metros (m.)" +($V{REPORT_COUNT}.equals($F{total_linderos}.intValue()) ? ", con el cual cierra el polÃ­gono," : ",")  + " colindando con "  + ($F{tipo_interesado}.equals("agrupacion")? "la agrupaciÃ³n conformada por "+ $F{interesado} +" y otros": $F{interesado})  +"."]]></textFieldExpression>
			</textField>
		</band>
	</detail>
</jasperReport>
